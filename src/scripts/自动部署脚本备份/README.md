Cloudloom Server 自动化部署说明
本文档详细介绍了 Cloudloom Server 项目的自动化部署方案，包括一套旧的方案和一套功能更强大、更推荐使用的新方案。

1. 新自动化部署方案（推荐）
   这是当前正在使用的、功能更完善的自动化部署方案。它采用 Git hooks、独立的部署脚本和回滚脚本，以实现一个健壮、安全的部署流程。

核心脚本文件

post-receive: 这是一个 Git hook 脚本，位于服务器 Git 仓库的 hooks/ 目录下 。它的主要作用是监控代码推送事件。当有新的代码被推送到

main 分支时，它会触发 deploy.sh 脚本并传递最新的提交哈希值 。

deploy.sh: 这是主要部署脚本，由 post-receive 触发执行 。它负责执行整个部署流程，包括版本管理、依赖安装、应用构建、健康检查和回滚等 。

rollback.sh: 这是一个手动回滚脚本，用于在需要时将应用恢复到指定的历史版本 。

deploy.sh 脚本工作流程详解

初始化与配置：脚本首先设置了颜色变量，然后定义了项目路径、发布目录、备份目录和日志目录等关键变量 。

创建版本发布目录：根据当前时间戳和最新的 Git 提交哈希值（作为部署 ID）创建一个新的、独立的发布目录，例如 /var/www/cloudloom-server/releases/20250830123000-abc1234 。

代码归档与复制：脚本使用 git archive 命令将最新的代码归档并解压到新创建的发布目录中 。

环境配置：如果 /var/www/cloudloom-server/.env 文件存在，脚本会将其复制到新的发布目录中 。然后，它会加载这些环境变量并验证是否设置了

DB_HOST、DB_PORT 和 DB_USERNAME 等关键变量 。

依赖安装与构建：脚本在新目录中运行 npm install 来安装所有依赖，然后执行 npx nest build 来构建项目 。

数据库连接检查：这是新方案的一个关键安全特性。在构建成功后，脚本会运行一个 TypeORM 脚本来验证数据库连接 。如果连接失败，部署将立即中止并触发回滚 。

更新符号链接：如果所有检查都通过，脚本会将 current 符号链接（/var/www/cloudloom-server/current）原子性地指向新版本的 dist 目录 。

服务重启与健康检查：脚本使用 PM2 重启服务 。然后，它会持续进行健康检查，向

http://localhost:3000/health 发送请求 。如果应用在设定的超时时间内没有响应，部署将失败并自动回滚 。

清理旧版本：部署成功后，脚本会自动删除旧的发布目录，只保留最新的 5 个版本以节省空间 。

rollback.sh 脚本使用指南
此脚本用于手动回滚到指定的历史版本，非常适合处理生产环境中的紧急问题。

使用方法：

你需要提供一个历史版本的时间戳，该时间戳可以在

releases 目录中找到 。

执行命令：

./rollback.sh [version_timestamp] 。

例如：

./rollback.sh 20240830120000 。

工作流程：

脚本会验证你提供的版本是否存在 。

如果存在，它会首先备份当前正在运行的版本 。

然后，它将

current 符号链接切换到目标版本的 dist 目录 。

最后，它会使用 PM2 重启服务，完成回滚 。

2. 旧自动化部署方案（已弃用）
   这是最初的部署方案，功能相对简单，所有逻辑都集成在一个脚本中。

核心脚本文件

post-receive-old: 这个脚本既是 Git hook，又包含了所有的部署逻辑 。

post-receive-old 脚本工作流程

创建版本目录：脚本首先创建一个新的发布目录 。

代码复制：使用 git archive 命令将代码复制到新目录 。

依赖与构建：在新目录中执行 npm install --production 和 npx nest build 。

更新符号链接：将 current 符号链接指向新构建的 dist 目录 。

PM2 管理：使用 pm2 startOrReload 命令来重启或启动服务 。

清理旧版本：最后，删除旧的发布版本，只保留最新的 5 个 。

新旧方案对比
| 特性 | 新方案 (deploy.sh) | 旧方案 (post-receive-old) | | :--- | :--- | :--- | | 工作原理 |
Git Hook 触发独立的部署脚本 Git Hook 和部署逻辑集成在一个脚本中

回滚机制 | 1. 自动回滚（健康检查失败时）<br> 2. 手动回滚（通过

rollback.sh） | 无自动回滚功能，失败时需要手动处理 | |

部署安全 |

高。在新版本完全构建并验证健康后才切换 。 |

低。如果构建失败，符号链接仍可能指向一个损坏的版本。 | | 数据库检查 |

有。在部署前会检查数据库连接，防止因配置错误导致部署失败 。| 无此功能。 | |

健康检查 |

有。部署后会持续检查应用健康状态 。 | 无此功能。 | |

可维护性 | 脚本职责分离，更易于维护和扩展。| 脚本功能混杂，不易维护。|
